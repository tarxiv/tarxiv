services:
  # Setup elasticsearch database with defined user roles and passwords
  setup_elasticsearch:
    profiles:
      - setup_elasticsearch
    image: docker.elastic.co/elasticsearch/elasticsearch:9.0.2
    init: true
    entrypoint: /entrypoint.sh
    volumes:
      - ./entrypoint.sh:/entrypoint.sh:ro,Z
      - ./lib.sh:/lib.sh:ro,Z
      - ./roles:/roles:ro,Z
    environment:
      ELASTIC_PASSWORD: ${TARXIV_ELASTIC_PASSWORD:-}
      LOGSTASH_INTERNAL_PASSWORD: ${TARXIV_LOGSTASH_INTERNAL_PASSWORD:-}
      KIBANA_SYSTEM_PASSWORD: ${TARXIV_KIBANA_SYSTEM_PASSWORD:-}
      BEATS_SYSTEM_PASSWORD: ${TARXIV_BEATS_SYSTEM_PASSWORD:-}

    networks:
      - tarxiv_net
    depends_on:
      - elasticsearch

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:9.0.2
    volumes:
      - ./elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro,Z
      - ${TARXIV_ELASTIC_DATA_DIR}:/usr/share/elasticsearch/data:Z
    ports:
      - 9200:9200
      - 9300:9300
    environment:
      node.name: elasticsearch
      discovery.type: single-node
      ELASTIC_PASSWORD: ${TARXIV_ELASTIC_PASSWORD}
      ES_JAVA_OPTS: -Xms${TARXIV_ELASTIC_MEMORY:-2048}m -Xmx${TARXIV_ELASTIC_MEMORY:-2048}m
    networks:
      - tarxiv_net
    restart: unless-stopped

  logstash:
    image: docker.elastic.co/logstash/logstash:9.0.2
    volumes:
      - ./logstash.yml:/usr/share/logstash/config/logstash.yml:ro,Z
      - ./tarxiv_logstash.conf:/usr/share/logstash/pipeline/tarxiv_logstash.conf:ro,Z
    ports:
      - 5044:5044
      - 5045:5045
      - 5046:5046
      - 50000:50000/tcp
      - 50000:50000/udp
      - 9600:9600
    environment:
      LS_JAVA_OPTS: -Xms${TARXIV_LOGSTASH_MEMORY:-512}m -Xmx${TARXIV_LOGSTASH_MEMORY:-512}m
      LOGSTASH_INTERNAL_PASSWORD: ${TARXIV_LOGSTASH_INTERNAL_PASSWORD}
      ELASTIC_PASSWORD: ${TARXIV_ELASTIC_PASSWORD}
    networks:
      - tarxiv_net
    depends_on:
      - elasticsearch
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:9.0.2
    volumes:
      - ./kibana.yml:/usr/share/kibana/config/kibana.yml:ro,Z
    ports:
      - 5601:5601
    environment:
        KIBANA_SYSTEM_PASSWORD: ${TARXIV_KIBANA_SYSTEM_PASSWORD}
    networks:
      - tarxiv_net
    depends_on:
      - elasticsearch
    restart: unless-stopped

  couchbase:
    image: couchbase:latest
    volumes:
      - ${TARXIV_COUCHBASE_DATA_DIR}:/opt/couchbase/var/lib/couchbase/data:Z
      - ./init_server.sh:/init_server.sh:ro,Z
    ports:
      - 8091-8096:8091-8096
      - 11210-11211:11210-11211
    networks:
      - tarxiv_net
    entrypoint: /init_server.sh
    environment:
      TARXIV_COUCHBASE_HOST: ${TARXIV_COUCHBASE_HOST}
      TARXIV_COUCHBASE_ADMIN_USERNAME: ${TARXIV_COUCHBASE_ADMIN_USERNAME:-}
      TARXIV_COUCHBASE_ADMIN_PASSWORD: ${TARXIV_COUCHBASE_ADMIN_PASSWORD:-}
      TARXIV_COUCHBASE_API_USERNAME: ${TARXIV_COUCHBASE_API_USERNAME:-}
      TARXIV_COUCHBASE_API_PASSWORD: ${TARXIV_COUCHBASE_API_PASSWORD:-}
      TARXIV_COUCHBASE_PIPELINE_USERNAME: ${TARXIV_COUCHBASE_PIPELINE_USERNAME:-}
      TARXIV_COUCHBASE_PIPELINE_PASSWORD: ${TARXIV_COUCHBASE_PIPELINE_PASSWORD:-}
      TARXIV_COUCHBASE_BUCKET_SIZE: ${TARXIV_COUCHBASE_BUCKET_SIZE:-2048}
    restart: unless-stopped

  redis:
    image: redis:latest
    volumes:
      - ${TARXIV_REDIS_DATA_DIR}:/data
    ports:
      - 6379:6379
    environment:
      - REDIS_PASSWORD:${TARXIV_REDIS_PASSWORD}
    networks:
      - tarxiv_net

  # Supabase services
  supabase-db:
    image: supabase/postgres:15.6.1.117
    ports:
      - 5432:5432
    environment:
      POSTGRES_HOST: /var/run/postgresql
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${SUPABASE_DB_NAME:-postgres}
      POSTGRES_USER: ${SUPABASE_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${SUPABASE_DB_PASSWORD:-your-super-secret-password}
      JWT_SECRET: ${SUPABASE_JWT_SECRET:-your-super-secret-jwt-token-with-at-least-32-characters-long}
      JWT_EXP: 3600
    volumes:
      - ${SUPABASE_DB_DATA_DIR:-.data/supabase/db}:/var/lib/postgresql/data:Z
      - ./supabase-init.sql:/docker-entrypoint-initdb.d/supabase-init.sql:ro
    networks:
      - tarxiv_net
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  supabase-auth:
    image: supabase/gotrue:v2.158.1
    ports:
      - 9999:9999
    environment:
      GOTRUE_API_HOST: 0.0.0.0
      GOTRUE_API_PORT: 9999
      API_EXTERNAL_URL: ${SUPABASE_API_EXTERNAL_URL:-http://localhost:8000}
      GOTRUE_DB_DRIVER: postgres
      GOTRUE_DB_DATABASE_URL: postgres://${SUPABASE_DB_USER:-postgres}:${SUPABASE_DB_PASSWORD:-your-super-secret-password}@supabase-db:5432/${SUPABASE_DB_NAME:-postgres}?search_path=auth
      GOTRUE_SITE_URL: ${SUPABASE_SITE_URL:-http://localhost:3000}
      GOTRUE_URI_ALLOW_LIST: ${SUPABASE_URI_ALLOW_LIST:-*}
      GOTRUE_DISABLE_SIGNUP: ${SUPABASE_DISABLE_SIGNUP:-false}
      GOTRUE_JWT_ADMIN_ROLES: service_role
      GOTRUE_JWT_AUD: authenticated
      GOTRUE_JWT_DEFAULT_GROUP_NAME: authenticated
      GOTRUE_JWT_EXP: 3600
      GOTRUE_JWT_SECRET: ${SUPABASE_JWT_SECRET:-your-super-secret-jwt-token-with-at-least-32-characters-long}
      GOTRUE_EXTERNAL_EMAIL_ENABLED: ${SUPABASE_EXTERNAL_EMAIL_ENABLED:-true}
      GOTRUE_MAILER_AUTOCONFIRM: ${SUPABASE_MAILER_AUTOCONFIRM:-true}
      GOTRUE_SMTP_HOST: ${SUPABASE_SMTP_HOST:-}
      GOTRUE_SMTP_PORT: ${SUPABASE_SMTP_PORT:-587}
      GOTRUE_SMTP_USER: ${SUPABASE_SMTP_USER:-}
      GOTRUE_SMTP_PASS: ${SUPABASE_SMTP_PASS:-}
      GOTRUE_SMTP_ADMIN_EMAIL: ${SUPABASE_SMTP_ADMIN_EMAIL:-admin@example.com}
      GOTRUE_MAILER_URLPATHS_CONFIRMATION: ${SUPABASE_MAILER_URLPATHS_CONFIRMATION:-/auth/v1/verify}
      GOTRUE_MAILER_URLPATHS_INVITE: ${SUPABASE_MAILER_URLPATHS_INVITE:-/auth/v1/verify}
      GOTRUE_MAILER_URLPATHS_RECOVERY: ${SUPABASE_MAILER_URLPATHS_RECOVERY:-/auth/v1/verify}
      GOTRUE_MAILER_URLPATHS_EMAIL_CHANGE: ${SUPABASE_MAILER_URLPATHS_EMAIL_CHANGE:-/auth/v1/verify}
    networks:
      - tarxiv_net
    depends_on:
      supabase-db:
        condition: service_healthy
    restart: unless-stopped

  supabase-rest:
    image: postgrest/postgrest:v12.2.0
    ports:
      - 3000:3000
    environment:
      PGRST_DB_URI: postgres://${SUPABASE_DB_USER:-postgres}:${SUPABASE_DB_PASSWORD:-your-super-secret-password}@supabase-db:5432/${SUPABASE_DB_NAME:-postgres}
      PGRST_DB_SCHEMAS: public,storage
      PGRST_DB_ANON_ROLE: anon
      PGRST_JWT_SECRET: ${SUPABASE_JWT_SECRET:-your-super-secret-jwt-token-with-at-least-32-characters-long}
      PGRST_DB_USE_LEGACY_GUCS: "false"
    networks:
      - tarxiv_net
    depends_on:
      supabase-db:
        condition: service_healthy
    restart: unless-stopped

  supabase-kong:
    image: kong:2.8.1
    ports:
      - 8000:8000
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /var/lib/kong/kong.yml
      KONG_DNS_ORDER: LAST,A,CNAME
      KONG_PLUGINS: request-transformer,cors,key-auth,acl
    volumes:
      - ./supabase-kong.yml:/var/lib/kong/kong.yml:ro
    networks:
      - tarxiv_net
    depends_on:
      - supabase-auth
      - supabase-rest
    restart: unless-stopped

  supabase-adminer:
    image: adminer:4.8.1
    ports:
      - 8080:8080
    environment:
      ADMINER_DEFAULT_SERVER: supabase-db
    depends_on:
      supabase-db:
        condition: service_healthy
    networks:
      - tarxiv_net
    restart: unless-stopped

  tarxiv-api:
    profiles:
      - tarxiv
    build:
      context: ..
      dockerfile: Dockerfile
    image: ${TARXIV_IMAGE_SOURCE:-local}/tarxiv:${TARXIV_IMAGE_TAG:-latest}
    container_name: tarxiv-api
      #user: "1000:1000"
    command: uv run /app/bin/start-api
    volumes:
      - ../bin:/app/bin:Z
      - ../tarxiv:/app/tarxiv:Z
      - ../aux/config.yml:/app/aux/config.yml:Z
      - ../examples:/app/examples:Z
      - ../scripts:/app/scripts:Z
      - ${TARXIV_HOST_LOG_DIR:-.data/logs}:/data/tarxiv/logs:rw,z
    ports:
      - ${TARXIV_PORT}:${TARXIV_PORT}
    environment:
      TARXIV_CONFIG_DIR: /app/aux
      TARXIV_COUCHBASE_HOST: couchbase
      TARXIV_COUCHBASE_API_USERNAME: ${TARXIV_COUCHBASE_API_USERNAME}
      TARXIV_COUCHBASE_API_PASSWORD: ${TARXIV_COUCHBASE_API_PASSWORD}
      TARXIV_ELASTIC_HOST: elasticsearch
      TARXIV_ELASTIC_PORT: 9200
      TARXIV_ELASTIC_PASSWORD: ${TARXIV_ELASTIC_PASSWORD}
      TARXIV_IMAGE_SOURCE: ${TARXIV_IMAGE_SOURCE:-local}
      TARXIV_IMAGE_TAG: ${TARXIV_IMAGE_TAG:-latest}
    networks:
      - tarxiv_net
    restart: unless-stopped

  tarxiv-dashboard:
    profiles:
      - tarxiv
    image: ${TARXIV_IMAGE_SOURCE:-local}/tarxiv:${TARXIV_IMAGE_TAG:-latest}
    command: uv run /app/bin/run_dashboard.py --host 0.0.0.0 --port ${TARXIV_DASHBOARD_PORT} --debug
    container_name: tarxiv-dashboard
    volumes:
      - ../bin:/app/bin:Z
      - ../tarxiv:/app/tarxiv:Z
      - ../aux/config.yml:/app/aux/config.yml:Z
      - ../examples:/app/examples:Z
      - ../scripts:/app/scripts:Z
      - ${TARXIV_HOST_LOG_DIR:-.data/logs}:/data/tarxiv/logs:rw,z
    ports:
      - 8050:8050
    environment:
      TARXIV_CONFIG_DIR: /app/aux
      TARXIV_COUCHBASE_HOST: couchbase
      TARXIV_COUCHBASE_API_USERNAME: ${TARXIV_COUCHBASE_API_USERNAME}
      TARXIV_COUCHBASE_API_PASSWORD: ${TARXIV_COUCHBASE_API_PASSWORD}
      TARXIV_ELASTIC_HOST: elasticsearch
      TARXIV_ELASTIC_PORT: 9200
      TARXIV_ELASTIC_PASSWORD: ${TARXIV_ELASTIC_PASSWORD}
      TARXIV_IMAGE_TAG: ${TARXIV_IMAGE_TAG:-latest}
      TARXIV_IMAGE_SOURCE: ${TARXIV_IMAGE_SOURCE:-local}
      SUPABASE_API_EXTERNAL_URL: http://supabase-kong:8000
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
    networks:
      - tarxiv_net
    restart: unless-stopped

networks:
  tarxiv_net:
    driver: bridge

volumes:
  elasticsearch:
